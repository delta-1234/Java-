# 项目需求

制作一个双人对战小游戏，角色能够进行跳跃，二段跳，普通攻击和技能攻击。

## 窗口创建

GameWindows继承JFrame类就可以实现窗口创建和监视鼠标键盘的功能。

**出现的问题：开始时，我将窗口设置为固定大小，但发现在其他人的电脑上打开时可能会出现窗口太大无法完全显示，或者窗口太小游玩体验不佳的问题。**

> 我的解决方案是利用Toolkid工具获得运行电脑的屏幕长度和宽度，并保存在Constant类中设置为static，方便以后调用，并在util工具类中写了两个高和宽转换方法，之后在我电脑上调试出的高和宽参数只需利用该方法转换就可以适配所有电脑屏幕，达到全屏的效果

开始界面BeginningInterface只需继承GameWindows类就可以直接创建一个空白窗口，之后的所有界面都开始都会继承GameWindows类。我在BeginningInterface中添加了几个按钮，通过对按钮进行监听进入不同的界面，比如游玩界面，按键设置界面等，之后将工程大致分为战斗界面设计、战斗逻辑设计和角色设计等部分进行

## 双人战斗界面

界面中包含角色所以先创建一个角色类

### 角色创建

因为不会绘画，所以使用了空洞骑士的图片作为角色的图片，在工具类中编写getImage方法，利用Toolkid获取图片，并设置异常中断，当图片不存在时catch并输出异常结果。将角色的不同状态图片存放在一个image数组中，利用state作为索引，选择不同状态的角色，在角色类中添加paint方法，将角色图片按照当前的x和y坐标画到画布上

在战斗界面中实例化两个角色，重写paint方法，将背景图片画到窗口上，再调用Character中paint方法将角色画到窗口中，就可以在窗口中看到两个角色

在战斗界面中添加按键监视，并利用Character中写好的修改state方法，即可达到利用按键控制角色的目的

### 角色移动

角色移动分为x方向和y方向，x方向移动比较简单，只需要收到按键信号后给角色一个初速度，编写x运动方法就能让角色动起来，再收到松开按键信号后将速度变为0，即可达到利用按键控制角色水平移动的效果。y方向移动比较复杂，按下跳跃键时，设置一个向上的y方向初速度，然后利用加速度公式计算出角色位置，同时还需要设置地面位置，使角色落到地面时停止运动，即y方向速度修改为0

**出现问题：角色无法移动**

> 在Character中写好了移动的方法，并在界面中调用，但角色无法移动，分析原因是战斗界面类只运行一次，无法更新角色位置和状态。 查阅资料后，我在战斗界面中利用Thread添加了一个线程，在线程中不断运行更新角色位置，这样角色就动起来了

**出现问题：游玩时画面闪烁**

> 查阅资料了解到，可能原因是背景和角色不是一次性画在窗口上的，导致角色会出现闪烁。我的解决方案是新建一个画布Graphics，先将背景和角色都画在新建画布上，再一次性将画布画在窗口上，解决了闪烁问题

### 障碍物创建

创建一个障碍物类，添加障碍物移动方法和paint方法，并在战斗界面中实例化一大一小两个障碍物

### 碰撞体积

需要给两个角色添加碰撞体积，我添加了碰撞类进行碰撞的判断，使两个角色不会进入对方的体内，用类似的方法为角色和障碍物添加碰撞体积。同时设置角色移动的边界，使其不会运动超出窗口范围。

**出现问题：碰撞体积无效，或者未碰撞就停止运动**

> 碰撞体积的编写这部分出现了许多奇怪的bug，比如角色与障碍物的碰撞无效，角色无法站在障碍物上，或者在障碍物上无法移动等。这些问题大部分都是因为我在判断碰撞时没有考虑到所有的情况导致的，还有一些需要特殊处理，比如角色无法站立在障碍物上，需要将角色的ground设置为障碍物表面，离开障碍物要复原为地面，不然无法下落；在障碍物上的移动问题，需要将角色速度进行变换，将相对障碍物速度变换为绝对速度。这部分问题我大部分是通过测试和调试进行解决的，先通过观察异常行为，推测可能原因，再设置好断点进行输出检验bug

### 角色攻击和技能

在角色类中添加攻击方法和几种不同的技能方法，并在角色类中设置血量和MP，写get和change方法留给外部调用修改角色血量和MP

**出现问题：攻击没有间隔**

> 发现只要按住攻击键，角色会一直进行攻击，这显然不对。解决方案是设置一个计数器，计数器清零后角色才能再次进行攻击，使角色两次攻击之间拥有间隔

编写好角色类中的攻击方法，需要再新增攻击与角色的碰撞判断，当攻击到对方角色时，利用changeHP改变对方角色血量。

技能中的冲击波和吼叫需要单独进行碰撞判断，冲击波发出后作为单独物体存在向前运动，可以击退敌人，所以需要用到changX方法改变敌人的水平位置；吼叫向上攻击，也可以击退敌人，利用changY方法改变敌人的垂直位置，同时释放时角色可以短暂滞空，即将释放角色的Yspeed短时间内设置为0

角色的二段跳实现比较简单，只需要在角色类中添加一个是否滞空的Boolean型变量用于判断，再添加一个计数器记录跳跃次数，使得在角色在空中时若未使用过二段跳，按下跳跃键即可再次跳跃。

### 回血球和回MP球设计

血球使用random方法随机生成，数量随机，位置随机，当屏幕上存在血球时不再生成新的血球，同时添加血球与角色的碰撞，角色接触到血球后使血球消失，角色血量恢复。

MP球的设计与血球类似

## 支持键位修改

新建一个SettingInterface类，在开始界面中添加setting按键，点击进入设置修改界面。

对于跳跃、移动、两个技能支持键位修改，添加对应的按钮，点击按钮之后按下键盘上对应按键修改设置。

实现方法：在工具类中添加keyChange方法，使其可以修改常数类中的对应键位的值，在SettingInterface中添加键盘监听和按钮监听，监听到按钮被按下后监听键盘获得按下的按键键值，利用keyChange方法进行修改。

**出现问题：按钮按下后按下键盘无法接收键值**

> 上网查询资料后得知，JFrame无法同时对键盘和按钮进行监听，因为按下按钮后就会聚焦按钮上，就无法进行键盘监听，解决方法是使用setRequestFocusEnabled方法使按钮失去焦点，键盘就可以正常进行监听获得键值了

# 单人模式

## 模式选择界面

在开始界面新增模式选择界面，点击PVE按钮即可进入单人模式

新增Enemy类，考虑到Character和Enemy的相似性，直接让Enemy继承Character类，这样只需在Enemy中编写其特有的部分，而像碰撞体积等可以直接使用父类，降低了开发复杂度

## Enemy

敌人类中新增移动方法，与父类不同，敌人不用键盘控制而是自动移动，通过一个计算与角色位置的方法，当敌人接近角色时，会主动向角色移动，攻击角色，而当角色远离敌人时，会进行随机移动。敌人都是会飞的，所以敌人不需要添加重力

我为敌人设置了两种不同的攻击模式，可以在实例化时进行选择，一种使用普通攻击，近距离攻击角色，另一种远程攻击，远距离攻击角色。

## PVE界面

在PVE类中实例化一个角色，同时实例化两个大敌人和若干个小敌人，敌人数量随机至少为3个，至多8个，大敌人使用远程攻击，小敌人使用近距离攻击，利用changeHP方法，设置大敌人血量为5，小敌人血量为3。

因为近距离攻击和角色的普攻类似，可以直接使用flighting包中编写的碰撞判断，远距离攻击同样与shockWave类似，也使用fighting包中相应方法进行判断。

fighting包中新增掉落伤害，因为PVE模式下无地面，当角色掉落下平台，将会扣血并重生在最下方的台阶上

# 开发完成

最后具备的功能为：

> 1. 双人对战，支持键位修改，可使用普通攻击，e技能和q技能，同时支持跳跃和二段跳
> 2. 可以通过拾取屏幕随机生成的血包进行回血，可以通过攻击对方获得MP，受到普攻伤害也会获得MP，同样可以拾取屏幕上随机出现的MP球进行MP恢复。e技能消耗2点MP，发出一道冲击波攻击一行的敌人，造成2点伤害，同时击退敌人；q技能消耗3点MP，向上攻击小范围的敌人，造成3点伤害，同时可以击退敌人，在空中释放可在空中悬停短暂时间
> 3. 可在模式选择界面中选择双人和单人模式，默认为双人模式，单人模式操控角色击败所有敌人即可胜利。敌人分为两种，一种小敌人，近战攻击，拥有3点血，打击到角色扣1点血；大敌人远程攻击，发出一个孢子团攻击角色，打击到角色扣2点血，大敌人拥有5点血
> 4. 开始界面中，点击Setting按钮进入键位设置，可以看到当前的键位，点击对应的按钮后按下想更改的按键即可更改，注意无法更改为相同按键
